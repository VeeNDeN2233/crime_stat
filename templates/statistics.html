{% extends "base.html" %}

{% block title %}Статистика преступлений{% endblock %}

{% block content %}
<div class="statistics-container">
    <h1>Статистика преступлений</h1>
    
    <div class="statistics-grid">
        <!-- Диаграмма 1: Количество преступлений по дням недели -->
        <div class="stat-card">
            <h2>По дням недели</h2>
            <canvas id="crimeByDayChart"></canvas>
        </div>

        <!-- Диаграмма 2: Топ-10 статей УК РФ -->
        <div class="stat-card">
            <h2>Топ-10 статей УК РФ</h2>
            <canvas id="crimeByArticleChart"></canvas>
        </div>

        <!-- Диаграмма 3: По отделам полиции -->
        <div class="stat-card">
            <h2>По отделам полиции</h2>
            <canvas id="crimeByDepartmentChart"></canvas>
        </div>

        <!-- Диаграмма 4: По районам города -->
        <div class="stat-card">
            <h2>По районам города</h2>
            <canvas id="crimeByDistrictChart"></canvas>
        </div>
    </div>
</div>

<style>
.statistics-container {
    padding: 20px;
}

.statistics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-card h2 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 1.2em;
    text-align: center;
}

canvas {
    width: 100% !important;
    height: 300px !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/statistics');
        if (!response.ok) {
            throw new Error('Ошибка загрузки статистики');
        }
        const data = await response.json();
        
        // Отладочная информация
        console.log('Все данные:', data);
        console.log('Данные районов:', data.districts);

        // Цветовая схема
        const colors = {
            primary: 'rgba(54, 162, 235, 0.8)',
            secondary: 'rgba(255, 99, 132, 0.8)',
            tertiary: 'rgba(75, 192, 192, 0.8)',
            background: 'rgba(255, 255, 255, 0.9)'
        };

        // Диаграмма по дням недели
        new Chart(document.getElementById('crimeByDayChart'), {
            type: 'bar',
            data: {
                labels: data.days.labels,
                datasets: [{
                    label: 'Количество преступлений',
                    data: data.days.data,
                    backgroundColor: colors.primary,
                    borderColor: colors.primary.replace('0.8', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Диаграмма по статьям
        new Chart(document.getElementById('crimeByArticleChart'), {
            type: 'bar',
            data: {
                labels: data.articles.labels,
                datasets: [{
                    label: 'Количество преступлений',
                    data: data.articles.data,
                    backgroundColor: colors.secondary,
                    borderColor: colors.secondary.replace('0.8', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Диаграмма по отделам
        new Chart(document.getElementById('crimeByDepartmentChart'), {
            type: 'doughnut',
            data: {
                labels: data.departments.labels,
                datasets: [{
                    data: data.departments.data,
                    backgroundColor: [
                        colors.primary,
                        colors.secondary,
                        colors.tertiary,
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 15
                        }
                    }
                }
            }
        });

        // Диаграмма по районам
        const districtCtx = document.getElementById('crimeByDistrictChart').getContext('2d');
        const districtChart = new Chart(districtCtx, {
            type: 'doughnut',
            data: {
                labels: data.districts.labels,
                datasets: [{
                    label: 'Количество преступлений',
                    data: data.districts.data,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',   // Синий
                        'rgba(255, 99, 132, 0.8)',   // Красный
                        'rgba(75, 192, 192, 0.8)',   // Бирюзовый
                        'rgba(255, 206, 86, 0.8)',   // Жёлтый
                        'rgba(153, 102, 255, 0.8)',  // Фиолетовый
                        'rgba(255, 159, 64, 0.8)'    // Оранжевый
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Ошибка:', error);
        document.querySelector('.statistics-container').innerHTML = `
            <div class="error-message">
                <h1>Ошибка загрузки статистики</h1>
                <p>${error.message}</p>
            </div>
        `;
    }
});
</script>
{% endblock %}