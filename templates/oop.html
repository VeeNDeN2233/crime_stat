{% extends "base.html" %}

{% block title %}Система ООП{% endblock %}

{% block content %}
<h1>Система планирования охраны общественного порядка</h1>

<div class="oop-container">
    <div class="form-container">
        <form id="event-form" class="event-form">
            <div class="form-group">
                <label for="location">Место проведения мероприятия:</label>
                <input type="text" id="location" name="location" 
                       placeholder="Например: площадь Ленина, Воронеж" required>
            </div>

            <div class="form-group">
                <label for="participants">Ожидаемое количество участников:</label>
                <input type="number" id="participants" name="participants" 
                       min="1" required>
            </div>

            <div class="form-group">
                <label for="event-type">Тип мероприятия:</label>
                <select id="event-type" name="event-type" required>
                    <option value="">Выберите тип мероприятия</option>
                    <option value="cultural">Культурное мероприятие</option>
                    <option value="sports">Спортивное мероприятие</option>
                    <option value="political">Общественно-политическое мероприятие</option>
                    <option value="celebration">Праздничное мероприятие</option>
                </select>
            </div>

            <div class="form-group">
                <label for="event-date">Дата проведения:</label>
                <input type="date" id="event-date" name="event-date" required>
            </div>

            <div class="form-group">
                <label for="event-time">Время начала:</label>
                <input type="time" id="event-time" name="event-time" required>
            </div>

            <div class="form-group">
                <label for="duration">Продолжительность (часов):</label>
                <input type="number" id="duration" name="duration" 
                       min="1" max="24" required>
            </div>

            <button type="submit" class="submit-button">Рассчитать план охраны</button>
        </form>
    </div>

    <div class="result-container">
        <div class="map-container">
            <div id="map" style="width: 100%; height: 500px;"></div>
        </div>
        
        <div class="stats-container">
            <h3>Результаты расчета:</h3>
            <div id="calculation-results">
                <!-- Здесь будут отображаться результаты расчета -->
            </div>
        </div>
    </div>
</div>

<style>
.oop-container {
    display: flex;
    gap: 20px;
    padding: 20px;
}

.form-container {
    flex: 0 0 300px;
}

.result-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.event-form {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.submit-button {
    width: 100%;
    padding: 10px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.submit-button:hover {
    background: #0056b3;
}

.stats-container {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
let myMap;
let eventMarker;
let securityPoints = [];
let blockadeLines = [];

// Инициализация карты
function initMap() {
    myMap = new ymaps.Map('map', {
        center: [51.672046, 39.184302], // Координаты центра Воронежа
        zoom: 13
    });

    // Добавляем поиск по карте
    let searchControl = new ymaps.control.SearchControl({
        options: {
            provider: 'yandex#search',
            boundedBy: [[51.5, 39.0], [51.8, 39.4]], // Ограничиваем поиск Воронежем
            strictBounds: true
        }
    });
    myMap.controls.add(searchControl);
}

// Обработка отправки формы
document.getElementById('event-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Получаем данные формы
    const formData = new FormData(this);
    const location = formData.get('location');
    const participants = parseInt(formData.get('participants'));
    
    try {
        // Геокодируем адрес
        const res = await ymaps.geocode(location + ', Воронеж');
        const firstGeoObject = res.geoObjects.get(0);
        const coords = firstGeoObject.geometry.getCoordinates();
        
        // Очищаем предыдущие метки
        clearMap();
        
        // Добавляем метку места проведения
        addEventMarker(coords);
        
        // Рассчитываем и отображаем зону охраны
        calculateSecurityZone(coords, participants);
        
        // Отображаем результаты расчета
        showResults(participants);
        
    } catch (error) {
        console.error('Ошибка при обработке данных:', error);
        alert('Произошла ошибка при обработке данных. Пожалуйста, проверьте введенный адрес.');
    }
});

// Очистка карты
function clearMap() {
    if (eventMarker) {
        myMap.geoObjects.remove(eventMarker);
    }
    securityPoints.forEach(point => myMap.geoObjects.remove(point));
    blockadeLines.forEach(line => myMap.geoObjects.remove(line));
    securityPoints = [];
    blockadeLines = [];
}

// Добавление метки места проведения
function addEventMarker(coords) {
    eventMarker = new ymaps.Placemark(coords, {
        balloonContent: 'Место проведения мероприятия'
    }, {
        preset: 'islands#redDotIcon'
    });
    myMap.geoObjects.add(eventMarker);
    myMap.setCenter(coords, 15);
}

// Расчет зоны охраны
function calculateSecurityZone(coords, participants) {
    // Радиус зоны в зависимости от количества участников
    const radius = Math.sqrt(participants) * 10;
    
    // Создаем круг вокруг места проведения
    const circle = new ymaps.Circle([coords, radius], {}, {
        fillColor: '#ff000022',
        strokeColor: '#ff0000',
        strokeWidth: 2
    });
    myMap.geoObjects.add(circle);
    
    // Добавляем точки охраны
    const pointsCount = Math.ceil(participants / 100); // 1 пост на каждые 100 участников
    for (let i = 0; i < pointsCount; i++) {
        const angle = (2 * Math.PI * i) / pointsCount;
        const pointCoords = [
            coords[0] + (radius * Math.cos(angle) / 100000),
            coords[1] + (radius * Math.sin(angle) / 100000)
        ];
        
        const securityPoint = new ymaps.Placemark(pointCoords, {
            balloonContent: `Пост охраны #${i + 1}`
        }, {
            preset: 'islands#blueDotIcon'
        });
        securityPoints.push(securityPoint);
        myMap.geoObjects.add(securityPoint);
    }
}

// Отображение результатов расчета
function showResults(participants) {
    const pointsCount = Math.ceil(participants / 100);
    const resultsHtml = `
        <div class="calculation-details">
            <p><strong>Необходимое количество постов:</strong> ${pointsCount}</p>
            <p><strong>Рекомендуемое количество сотрудников:</strong> ${pointsCount * 2}</p>
            <p><strong>Дополнительные силы:</strong></p>
            <ul>
                <li>Патрульные экипажи: ${Math.ceil(pointsCount / 5)}</li>
                <li>Мобильный резерв: ${Math.ceil(pointsCount / 3)} сотрудников</li>
            </ul>
        </div>
    `;
    
    document.getElementById('calculation-results').innerHTML = resultsHtml;
}

// Инициализация при загрузке страницы
ymaps.ready(initMap);
</script>
{% endblock %} 