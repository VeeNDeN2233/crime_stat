{% extends "base.html" %}

{% block title %}Все преступления{% endblock %}

{% block content %}
<h1>Список всех преступлений</h1>

<div class="filters">
    <form id="filter-form" class="filter-form">
        <div class="filter-group">
            <label for="department">Отдел полиции:</label>
            <select id="department" name="department_id">
                <option value="">Все отделы</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="start_date">Дата с:</label>
            <input type="date" id="start_date" name="start_date">
        </div>

        <div class="filter-group">
            <label for="end_date">Дата по:</label>
            <input type="date" id="end_date" name="end_date">
        </div>

        <div class="filter-group">
            <label for="article">Статья УК РФ:</label>
            <input type="text" id="article" name="article" placeholder="Например: 158" 
                   pattern="[0-9]{1,3}(?:\.[0-9]{1,2})?" 
                   title="Введите номер статьи УК РФ (например: 158 или 158.1)">
        </div>

        <button type="submit" class="filter-button">Применить фильтры</button>
        <button type="button" id="reset-filters" class="filter-button">Сбросить</button>
    </form>
</div>

<div class="content-wrapper">
    <div class="table-container">
        <table class="crimes-table">
            <thead>
                <tr>
                    <th style="width: 120px;">Дата</th>
                    <th>Время</th>
                    <th>Статья УК РФ</th>
                    <th>Номер КУСП</th>
                    <th>Адрес</th>
                    <th>Отдел полиции</th>
                    <th>Дежурный</th>
                    <th>Телефон дежурного</th>
                </tr>
            </thead>
            <tbody id="crime-table">
                <!-- Данные будут загружаться через JavaScript -->
            </tbody>
        </table>
    </div>

    <div id="map" class="map-container"></div>
</div>

<style>
.content-wrapper {
    display: flex;
    gap: 20px;
    margin: 20px;
}

.table-container {
    flex: 1;
    overflow-x: auto;
}

.map-container {
    flex: 1;
    height: 600px;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.filters {
    margin: 20px;
    padding: 20px;
    background-color: #f5f5f5;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: bold;
    color: #333;
}

.filter-group select,
.filter-group input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 200px;
}

.filter-button {
    padding: 8px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    height: 35px;
}

.filter-button:hover {
    background-color: #45a049;
}

#reset-filters {
    background-color: #f44336;
}

#reset-filters:hover {
    background-color: #da190b;
}

.crimes-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.crimes-table th,
.crimes-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.crimes-table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.crimes-table tr:hover {
    background-color: #f9f9f9;
    cursor: pointer;
}
</style>

<script>
let myMap;
let markers = [];

// Инициализация карты
function initMap() {
    myMap = new ymaps.Map('map', {
        center: [51.672046, 39.184302], // Координаты центра Воронежа
        zoom: 12
    });
}

// Геокодирование адреса
function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
        ymaps.geocode(address, {
            results: 1
        }).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            if (firstGeoObject) {
                const coordinates = firstGeoObject.geometry.getCoordinates();
                resolve({
                    coordinates: coordinates,
                    address: firstGeoObject.getAddressLine()
                });
            } else {
                reject(new Error('Адрес не найден'));
            }
        }).catch(reject);
    });
}

// Добавление метки на карту
function addMarker(coordinates, properties) {
    const marker = new ymaps.Placemark(coordinates, {
        balloonContent: `
            <strong>Дата:</strong> ${properties.incident_date}<br>
            <strong>Время:</strong> ${properties.incident_time}<br>
            <strong>Статья:</strong> ${properties.article}<br>
            <strong>КУСП:</strong> ${properties.kusp_number}<br>
            <strong>Адрес:</strong> ${properties.address}<br>
            <strong>Отдел:</strong> ${properties.department_name || '-'}<br>
            <strong>Дежурный:</strong> ${properties.officer_name || '-'}
        `
    }, {
        preset: 'islands#redDotIcon'
    });
    
    markers.push(marker);
    myMap.geoObjects.add(marker);
}

// Очистка всех меток
function clearMarkers() {
    markers.forEach(marker => myMap.geoObjects.remove(marker));
    markers = [];
}

// Загрузка списка отделов
function loadDepartments() {
    fetch('/api/departments')
        .then(response => response.json())
        .then(departments => {
            const select = document.getElementById('department');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading departments:', error));
}

// Загрузка данных с фильтрами
async function loadData(filters = {}) {
    const queryParams = new URLSearchParams(filters);
    try {
        const response = await fetch(`/api/crimes?${queryParams}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const table = document.getElementById('crime-table');
        if (data.error) {
            table.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">${data.error}</td></tr>`;
            return;
        }
        
        if (data.length === 0) {
            table.innerHTML = '<tr><td colspan="8" style="text-align: center;">Нет данных о преступлениях</td></tr>';
            return;
        }

        // Очищаем таблицу и метки
        table.innerHTML = '';
        clearMarkers();

        // Обрабатываем каждое преступление
        for (const crime of data) {
            // Добавляем строку в таблицу
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="width: 120px;">${crime.incident_date}</td>
                <td>${crime.incident_time}</td>
                <td>${crime.article}</td>
                <td>${crime.kusp_number}</td>
                <td>${crime.address}</td>
                <td>${crime.department_name || '-'}</td>
                <td>${crime.officer_name || '-'}</td>
                <td>${crime.officer_phone || '-'}</td>
            `;
            table.appendChild(row);

            // Геокодируем адрес и добавляем метку
            try {
                const geoResult = await geocodeAddress(crime.address);
                addMarker(geoResult.coordinates, crime);
            } catch (error) {
                console.error(`Ошибка геокодирования для адреса ${crime.address}:`, error);
            }
        }

        // Если есть метки, центрируем карту по ним
        if (markers.length > 0) {
            myMap.setBounds(myMap.geoObjects.getBounds(), {
                checkZoomRange: true
            });
        }
    } catch (error) {
        const table = document.getElementById('crime-table');
        table.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">Ошибка при загрузке данных: ${error.message}</td></tr>`;
    }
}

// Обработка отправки формы
document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const filters = {};
    
    // Обработка всех полей формы
    for (let [key, value] of formData.entries()) {
        if (value) {  // Добавляем только непустые значения
            if (key === 'start_date' || key === 'end_date') {
                // Преобразуем дату в формат YYYY-MM-DD
                const date = new Date(value);
                filters[key] = date.toISOString().split('T')[0];
            } else if (key === 'article') {
                // Очищаем и форматируем номер статьи
                const cleanArticle = value.trim().replace(/[^\d.]/g, '');
                if (cleanArticle) {
                    filters[key] = cleanArticle;
                }
            } else {
                filters[key] = value;
            }
        }
    }
    
    // Показываем индикатор загрузки
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Загрузка...';
    
    loadData(filters)
        .finally(() => {
            // Восстанавливаем кнопку
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        });
});

// Добавляем обработчик ввода для поля статьи
document.getElementById('article').addEventListener('input', function(e) {
    // Очищаем ввод от всего, кроме цифр и точки
    this.value = this.value.replace(/[^\d.]/g, '');
    
    // Проверяем формат (максимум 3 цифры до точки и 2 после)
    const parts = this.value.split('.');
    if (parts.length > 2) {
        this.value = parts[0] + '.' + parts[1];
    }
    if (parts[0].length > 3) {
        this.value = parts[0].substring(0, 3) + (parts[1] ? '.' + parts[1] : '');
    }
    if (parts[1] && parts[1].length > 2) {
        this.value = parts[0] + '.' + parts[1].substring(0, 2);
    }
});

// Сброс фильтров
document.getElementById('reset-filters').addEventListener('click', function() {
    document.getElementById('filter-form').reset();
    loadData();
});

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    ymaps.ready(initMap);
    loadDepartments();
    loadData();
});
</script>
{% endblock %}